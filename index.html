<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Profile Pi Card</title>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    Pi.init({ version: "2.0" });
  </script>
</head>

<body>
  <button id="login">Login with Pi</button>
  <div id="app"></div>

  <script>
    const scopes = ["username", "payments"];
    let paymentInProgress = false;

    const loginBtn = document.getElementById("login");
    const app = document.getElementById("app");

    loginBtn.onclick = async () => {
      try {
        const auth = await Pi.authenticate(scopes, () => {});
        loginBtn.style.display = "none";

        app.innerHTML = `
          <h2>Welcome ${auth.user.username}</h2>
          <button id="pay">PAY TEST (0.01 Pi)</button>
          <p id="status"></p>
        `;

        document.getElementById("pay").onclick = startPayment;
      } catch (e) {
        alert("Authentication failed");
        console.error(e);
      }
    };

    async function serverAction(paymentId, action) {
      const res = await fetch("/api/pi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paymentId, action })
      });

      if (!res.ok) {
        throw new Error(await res.text());
      }

      return res.json();
    }

    function startPayment() {
      if (paymentInProgress) return;
      paymentInProgress = true;

      document.getElementById("status").innerText = "Opening Pi Wallet...";

      Pi.createPayment(
        {
          amount: 0.01,
          memo: "Profile Pi Card test payment",
          metadata: { test: true }
        },
        {
          onReadyForServerApproval: async (paymentId) => {
            document.getElementById("status").innerText = "Approving payment...";
            await serverAction(paymentId, "approve");
          },

          onReadyForServerCompletion: async (paymentId) => {
            document.getElementById("status").innerText = "Completing payment...";
            await serverAction(paymentId, "complete");
            document.getElementById("status").innerText = "✅ Payment completed";
            paymentInProgress = false;
          },

          onCancel: () => {
            document.getElementById("status").innerText = "❌ Payment cancelled";
            paymentInProgress = false;
          },

          onError: (err) => {
            console.error(err);
            document.getElementById("status").innerText = "⚠️ Payment error";
            paymentInProgress = false;
          }
        }
      );
    }
  </script>
</body>
</html>
