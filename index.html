<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Identity Pi Card</title>

    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
  const scopes = ["username", "payments"];
  let paymentInProgress = false;

  document.getElementById("login").onclick = async () => {
    try {
      const auth = await Pi.authenticate(scopes, (payment) => {
        console.log("Incomplete payment", payment);
      });

      document.getElementById("app").innerHTML = `
        <h2>Welcome ${auth.user.username}</h2>
        <button id="pay">PAY TEST (0.01 Pi)</button>
        <p id="status"></p>
      `;

      document.getElementById("pay").onclick = startPayment;
    } catch (err) {
      console.error(err);
      alert("Authentication failed");
    }
  };

  async function startPayment() {
    if (paymentInProgress) return;
    paymentInProgress = true;

    document.getElementById("status").textContent =
      "Opening Pi Wallet...";

    try {
      await Pi.createPayment({
        amount: 0.01,
        memo: "Identity Pi Card â€“ Test Payment",
        metadata: { test: true },

        onReadyForServerApproval: async (paymentId) => {
          await fetch("/api/pi", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId, action: "approve" }),
          });
        },

        onReadyForServerCompletion: async (paymentId) => {
          await fetch("/api/pi", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId, action: "complete" }),
          });

          document.getElementById("status").innerHTML =
            '<span class="ok">Payment completed successfully</span>';

          paymentInProgress = false;
        },

        onCancel: async (paymentId) => {
          await fetch("/api/pi", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId, action: "cancel" }),
          });

          document.getElementById("status").innerHTML =
            '<span class="error">Payment cancelled</span>';

          paymentInProgress = false;
        },

        onError: (err) => {
          console.error(err);
          document.getElementById("status").innerHTML =
            '<span class="error">Payment error</span>';
          paymentInProgress = false;
        },
      });
    } catch (err) {
      console.error(err);
      document.getElementById("status").innerHTML =
        '<span class="error">Unexpected error</span>';
      paymentInProgress = false;
    }
  }
</script>

  </body>
</html>
